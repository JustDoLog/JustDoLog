{% extends "base.html" %}
{% load static %}

{% block title %}{{ post.title }} - {{ post.blog.owner.username }}{% endblock %}
{% block og_title %}{{ post.title }}{% endblock %}
{% block og_description %}{{ post.content|striptags|safe|truncatechars:150 }}{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="{% static 'js/like-handler.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-[800px]">
    <!-- 포스트 제목 -->
    <h1 class="text-3xl font-bold text-gray-900 mb-8">
        {{ post.title }}
    </h1>

    <!-- 작성자 정보 및 메타데이터 -->
    <div class="flex items-center justify-between mb-8 pb-8 border-b border-gray-100">
        <div class="flex items-center gap-4">
            <!-- 프로필 이미지 -->
            <a href="{% url 'user_blog_main' username=post.blog.owner.username %}" 
               class="block">
                {% if post.blog.owner.profile_image %}
                    <img src="{{ post.blog.owner.profile_image.url }}"
                         alt=""
                         class="w-12 h-12 rounded-full object-cover">
                {% else %}
                    <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                {% endif %}
            </a>

            <!-- 작성자 정보 -->
            <div class="flex flex-col gap-2">
                <a href="{% url 'user_blog_main' username=post.blog.owner.username %}" 
                   class="text-base font-medium text-gray-900 hover:underline">
                    {{ post.blog.owner.username }}
                </a>

                <!-- 작성일 -->
                <span class="text-sm text-gray-500">
                    {{ post.created_at|date:"Y년 m월 d일" }}
                </span>
            </div>

            <!-- 팔로우 버튼 -->
            {% if user.is_authenticated and user != post.blog.owner %}
                <button hx-post="{% url 'follow_user' username=post.blog.owner.username %}"
                        hx-swap="outerHTML"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        class="{% if is_following %}bg-gray-900 text-white hover:bg-gray-800{% else %}text-gray-900 bg-white border border-gray-900 hover:bg-gray-50{% endif %} px-6 py-2 text-sm font-medium rounded-full transition-colors">
                    {% if is_following %}
                        팔로잉
                    {% else %}
                        팔로우
                    {% endif %}
                </button>
            {% endif %}
        </div>
    </div>

    <!-- 포스트 메타 정보 -->
    <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-6 text-sm text-gray-500">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span>{{ post.views }}</span>
            </div>
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                          d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <span class="post-likes-count">{{ post.likes }}</span>
            </div>
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span>{{ post.comments.count }}</span>
            </div>
        </div>

        <!-- 좋아요 버튼 -->
        <button class="like-button flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors {% if has_liked %}text-gray-900{% endif %}"
                {% if user.is_authenticated %}
                    hx-post="{% url 'toggle_like' username=post.blog.owner.username slug=post.slug %}"
                    hx-swap="none"
                    hx-trigger="click"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                {% else %}
                    onclick="window.location.href='{% url 'account_login' %}?next={{ request.path }}'"
                {% endif %}>
            <svg class="w-6 h-6" fill="{% if has_liked %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            <span class="likes-count">{{ post.likes }}</span>
        </button>
    </div>

    <!-- 포스트 본문 -->
    <div class="prose max-w-none">
        {{ post.content|safe }}
    </div>

    <!-- 태그 -->
    {% if post.tags.all %}
    <div class="flex items-center space-x-2">
        {% for tag in post.tags.all %}
        <a href="{% url 'tagged_posts' tag_name=tag.name %}" class="px-3 py-1 text-sm text-gray-600 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
            #{{ tag.name }}
        </a>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- JavaScript for handling likes -->
<script src="{% static 'js/like-handler.js' %}"></script>
{% endblock %}
